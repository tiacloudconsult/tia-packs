name: GitHub Sync with StackStorm
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  Git-Sync-Feature-to-StackStorm:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: Azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.CLIENT_ID }}","clientSecret":"${{ secrets.CLIENT_SECRET }}","subscriptionId":"${{ secrets.SUBSCRIPTION_ID }}","tenantId":"${{ secrets.TENANT_ID }}"}'
      - name: Azure CLI
        uses: azure/CLI@v1
        id: GetSecretValueWithCLI
        with:
          inlineScript: |
            echo "SECRET_VALUE=$(az keyvault secret show --name "st2-api-key-dev" --vault-name "argocd-tfs-kvault" --query "value")" >> $GITHUB_ENV
      - name: Send webhook request
        run: |
          curl -X POST http://st2.dev.tiacloud.io/v1/webhooks/argocd_triggerapi/ \
          -H "Content-Type: application/json" \
          -H "St2-Api-Key: ${{ env.SECRET_VALUE }}" \
          -d \
          '{
                "git_branch": "argocd-jinja2-crossplane-tf-demo",
                "config_template": "config.j2",
                "config_file": "config.yml",
                "yaml_template": "namespace_config.j2",
                "yaml_file": "namespaces.yaml",
                "input_vars": {
                  "teamName": "fork",
                  "server": "test3",
                  "environment": "dev-dev",
                  "token": "hello",
                  "ca": "yea"
            }
          }'
          
          

